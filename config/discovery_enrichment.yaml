# Discovery Enrichment Configuration
# Merges live API discovery data into published specifications
#
# Discovery data is generated by: make discover
# Output location: specs/discovered/
#
# This enrichment adds x-discovered-* extensions to enhance specs
# with real-world constraints, patterns, and examples without
# modifying the core OpenAPI schema.

discovery_enrichment:
  # Master switch for discovery-driven enrichment
  enabled: true

  # Location of discovered API specifications
  discovered_specs_dir: "specs/discovered"

  # Constraint enhancement settings
  constraints:
    # Add x-discovered-min-length, x-discovered-max-length, x-discovered-pattern
    add_discovered_constraints: true

    # Minimum confidence level to add a constraint (0.0-1.0)
    # Higher = more conservative, only add high-confidence discoveries
    confidence_threshold: 0.8

    # Minimum number of samples required before inferring a constraint
    # Prevents overfitting to small sample sizes
    min_sample_size: 5

    # List of fields to always enhance if discovered
    priority_fields:
      - name
      - namespace
      - tenant
      - uid
      - description

  # Real example injection settings
  examples:
    # Inject actual API responses as schema examples
    inject_real_examples: true

    # Maximum examples to include per schema
    max_examples_per_schema: 3

    # Sanitize potentially sensitive data from examples
    sanitize_pii: true

    # Fields to redact in examples (regex patterns)
    redact_patterns:
      - ".*password.*"
      - ".*secret.*"
      - ".*token.*"
      - ".*key.*"
      - ".*credential.*"

  # Field mutability detection
  mutability:
    # Detect and mark read-only fields (present in GET but not in POST/PUT body)
    detect_read_only: true

    # Detect and mark write-only fields (present in POST/PUT but not in GET)
    detect_write_only: true

    # Fields known to be read-only (always mark as such)
    known_read_only:
      - uid
      - creation_timestamp
      - modification_timestamp
      - creator
      - object_index
      - tenant

    # Fields known to be write-only
    known_write_only: []

  # Performance metadata
  performance:
    # Add x-response-time-baseline-ms from discovery data
    add_response_times: true

    # Add x-discovery-sample-size
    add_sample_size: true

    # Add x-discovery-confidence
    add_confidence: true

  # Extension naming
  extensions:
    # Prefix for all discovery extensions
    prefix: "x-discovered"

    # Full extension names (derived from prefix)
    # x-discovered-min-length
    # x-discovered-max-length
    # x-discovered-pattern
    # x-discovered-default
    # x-discovered-enum-values
    # x-discovered-at
    # x-discovered-sample-size
    # x-discovered-confidence
    # x-field-mutability (special, not prefixed)

  # Universal metadata layer enhancement
  metadata_layer:
    # Add universal metadata documentation
    document_universal_fields: true

    # Universal fields found across all resources
    universal_fields:
      tenant:
        description: "Tenant identifier for the resource"
        x-discovered-min-length: 6
        x-discovered-max-length: 25
      namespace:
        description: "Namespace containing the resource"
        x-discovered-min-length: 1
        x-discovered-max-length: 64
      name:
        description: "Unique name of the resource within namespace"
        x-discovered-min-length: 1
        x-discovered-max-length: 64
        x-discovered-pattern: "^[a-z0-9]([a-z0-9-]*[a-z0-9])?$"
      uid:
        description: "Unique identifier (UUID format)"
        format: uuid
        x-discovered-min-length: 36
        x-discovered-max-length: 36
      description:
        description: "Human-readable description of the resource"
        x-discovered-max-length: 1024
      disabled:
        description: "Whether the resource is disabled"
        type: boolean
      labels:
        description: "Key-value labels for organization and filtering"
        type: object
      annotations:
        description: "Key-value annotations for metadata"
        type: object

  # Response envelope documentation
  response_envelope:
    # Document the universal items/errors envelope
    document_envelope: true

    # Standard envelope structure
    envelope_schema:
      type: object
      properties:
        items:
          type: array
          description: "List of resource objects"
        errors:
          type: array
          items:
            type: string
          description: "List of error messages, if any"

  # Logging and reporting
  reporting:
    # Generate constraint comparison report
    generate_report: true

    # Report output directory
    report_dir: "reports"

    # Report filename
    report_filename: "constraint-analysis.md"

    # Include statistics in report
    include_statistics: true

    # Include field-by-field comparison
    include_field_comparison: true

# Constraint Reconciliation Configuration
# Reconciles discovered values INTO standard OpenAPI fields
# Discovery values from live API are treated as source of truth
reconciliation:
  # Master switch for reconciliation
  enabled: true

  # Reconciliation mode:
  #   - "replace": Always use discovered value (discovery is source of truth) [DEFAULT]
  #   - "tighten": Only update if discovered constraint is stricter
  #   - "add_missing": Only add if published field is missing
  mode: "replace"

  # Minimum confidence level to reconcile a constraint (0.0-1.0)
  confidence_threshold: 0.8

  # Minimum sample size required before reconciling
  min_sample_size: 5

  # Maintain audit trail of changes
  # - x-original-* for overwritten values
  # - x-reconciled-* for traceability
  audit_enabled: true

  # Field-specific mode overrides
  # Use to be more conservative with sensitive fields
  field_rules:
    # Patterns are sensitive - only add if missing
    pattern:
      mode: "add_missing"

    # Type changes can be breaking - only add if missing
    type:
      mode: "add_missing"
